name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect changes
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      frontend: ${{ steps.changes.outputs.frontend }}
      operator: ${{ steps.changes.outputs.operator }}
      markdown: ${{ steps.changes.outputs.markdown }}
      yaml: ${{ steps.changes.outputs.yaml }}
      docker: ${{ steps.changes.outputs.docker }}
      shell: ${{ steps.changes.outputs.shell }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            rust:
              - 'services/**/*.rs'
              - 'services/Cargo.toml'
            frontend:
              - 'frontend/**/*.ts'
              - 'frontend/**/*.tsx'
              - 'frontend/**/*.js'
              - 'frontend/**/*.jsx'
              - 'frontend/**/*.css'
            operator:
              - 'operator/**/*.rs'
              - 'operator/Cargo.toml'
            markdown:
              - '**/*.md'
            yaml:
              - '**/*.yaml'
              - '**/*.yml'
            docker:
              - 'docker/**'
              - 'Dockerfile*'
            shell:
              - '**/*.sh'
              - 'scripts/**'

  # Rust formatting and linting
  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            services/target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: services

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::all -D clippy::pedantic -A clippy::module_name_repetitions -A clippy::must_use_candidate
        working-directory: services

      - name: Check for unused dependencies
        run: |
          cargo install cargo-machete || true
          cargo machete || true
        working-directory: services

  # Operator Rust lint
  operator-lint:
    name: Operator Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.operator == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            operator/target
          key: ${{ runner.os }}-cargo-operator-lint-${{ hashFiles('operator/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: operator

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: operator

  # Frontend linting
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: frontend

      - name: Run ESLint
        run: pnpm lint
        working-directory: frontend

      - name: Run Prettier check
        run: pnpm exec prettier --check "src/**/*.{ts,tsx,js,jsx,css,json}"
        working-directory: frontend

      - name: Run TypeScript check
        run: pnpm typecheck
        working-directory: frontend

  # Markdown linting
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.markdown == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install markdownlint-cli2
        run: npm install -g markdownlint-cli2

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true }
          }
          EOF

      - name: Run markdownlint
        run: markdownlint-cli2 "**/*.md" "#node_modules" "#target" "#.output"
        continue-on-error: true

  # YAML linting
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.yaml == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml << 'EOF'
          extends: default
          rules:
            line-length:
              max: 200
              allow-non-breakable-words: true
              allow-non-breakable-inline-mappings: true
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no', 'on', 'off']
            comments:
              min-spaces-from-content: 1
            document-start: disable
            indentation:
              indent-sequences: whatever
          ignore:
            - charts/**/templates/
            - .github/
          EOF

      - name: Run yamllint
        run: yamllint -c .yamllint.yml .
        continue-on-error: true

  # Dockerfile linting
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.docker == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          ignore: DL3008,DL3013,DL3018,SC2086

  # Shell script linting
  shell-lint:
    name: Shell Script Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.shell == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        continue-on-error: true

      - name: Run shfmt
        uses: mvdan/sh/cmd/shfmt@v3
        continue-on-error: true

  # Helm lint
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Bitnami repo
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Run helm lint
        run: helm lint charts/pistonprotection

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Run chart-testing lint
        run: ct lint --target-branch main --charts charts/pistonprotection
        continue-on-error: true

  # EditorConfig check
  editorconfig:
    name: EditorConfig Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .editorconfig if not exists
        run: |
          if [ ! -f .editorconfig ]; then
            cat > .editorconfig << 'EOF'
          root = true

          [*]
          end_of_line = lf
          insert_final_newline = true
          trim_trailing_whitespace = true
          charset = utf-8

          [*.rs]
          indent_style = space
          indent_size = 4

          [*.{ts,tsx,js,jsx,json}]
          indent_style = space
          indent_size = 2

          [*.{yaml,yml}]
          indent_style = space
          indent_size = 2

          [*.md]
          trim_trailing_whitespace = false

          [Makefile]
          indent_style = tab
          EOF
          fi

      - name: Check EditorConfig
        uses: editorconfig-checker/action-editorconfig-checker@main
        continue-on-error: true

  # Lint summary
  lint-success:
    name: Lint Success
    runs-on: ubuntu-latest
    needs:
      - rust-lint
      - operator-lint
      - frontend-lint
      - markdown-lint
      - yaml-lint
      - dockerfile-lint
      - shell-lint
      - helm-lint
    if: always()
    steps:
      - name: Check lint results
        run: |
          # Create summary
          echo "# Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Linter | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | ${{ needs.rust-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Operator | ${{ needs.operator-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown | ${{ needs.markdown-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile | ${{ needs.dockerfile-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shell | ${{ needs.shell-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm | ${{ needs.helm-lint.result }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if critical linters failed
          if [[ "${{ needs.rust-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-lint.result }}" == "failure" ]]; then
            echo "Critical linter(s) failed"
            exit 1
          fi
