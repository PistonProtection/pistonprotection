---
title: Bare Metal Deployment
description: Deploy PistonProtection directly on Linux servers.
---

# Bare Metal Deployment

Deploy PistonProtection directly on Linux servers for maximum performance.

## Prerequisites

- Linux kernel 5.15+ (6.1+ recommended)
- Root access
- Rust toolchain
- PostgreSQL 15+
- Redis 7+

## System Preparation

### Kernel Configuration

Ensure kernel supports XDP:

```bash
# Check kernel version
uname -r

# Verify XDP support
grep -i xdp /boot/config-$(uname -r)

# Load required modules
modprobe xdp_generic
```

### Network Tuning

Optimize network for high-performance:

```bash
# /etc/sysctl.conf
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.netdev_max_backlog = 250000
net.core.somaxconn = 65535
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_syncookies = 1

# Apply
sysctl -p
```

### Create Service User

```bash
useradd -r -s /bin/false pistonprotection
mkdir -p /opt/pistonprotection
chown pistonprotection:pistonprotection /opt/pistonprotection
```

## Build from Source

```bash
# Clone repository
git clone https://github.com/pistonprotection/app.git
cd pistonprotection

# Install dependencies
make deps

# Build release binaries
make build-release

# Install binaries
cp target/release/gateway /opt/pistonprotection/
cp target/release/worker /opt/pistonprotection/
cp target/release/config-mgr /opt/pistonprotection/
cp target/release/metrics /opt/pistonprotection/
cp target/release/auth /opt/pistonprotection/

# Install eBPF programs
mkdir -p /opt/pistonprotection/ebpf
cp target/bpfel-unknown-none/release/*.o /opt/pistonprotection/ebpf/
```

## Configuration

### Gateway Configuration

```toml
# /etc/pistonprotection/gateway.toml
[server]
http_addr = "0.0.0.0:8080"
grpc_addr = "0.0.0.0:9090"
metrics_addr = "0.0.0.0:9091"

[database]
url = "postgres://pistonprotection:password@localhost/pistonprotection"
max_connections = 100

[redis]
url = "redis://localhost:6379"

[auth]
jwt_secret = "your-secure-jwt-secret-minimum-32-characters"
token_expiry = "24h"

[logging]
level = "info"
format = "json"
```

### Worker Configuration

```toml
# /etc/pistonprotection/worker.toml
[server]
http_addr = "0.0.0.0:8080"
metrics_addr = "0.0.0.0:9091"

[ebpf]
programs_path = "/opt/pistonprotection/ebpf"
interface = "eth0"
xdp_mode = "native"  # native, skb, or generic

[redis]
url = "redis://localhost:6379"

[config_mgr]
url = "http://localhost:8082"

[logging]
level = "info"
```

## Systemd Services

### Gateway Service

```ini
# /etc/systemd/system/pistonprotection-gateway.service
[Unit]
Description=PistonProtection Gateway
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=pistonprotection
Group=pistonprotection
ExecStart=/opt/pistonprotection/gateway --config /etc/pistonprotection/gateway.toml
Restart=always
RestartSec=5

# Security
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

### Worker Service

```ini
# /etc/systemd/system/pistonprotection-worker.service
[Unit]
Description=PistonProtection Worker
After=network.target

[Service]
Type=simple
User=root
ExecStart=/opt/pistonprotection/worker --config /etc/pistonprotection/worker.toml
Restart=always
RestartSec=5

# Worker needs elevated privileges for eBPF
AmbientCapabilities=CAP_NET_ADMIN CAP_SYS_ADMIN CAP_BPF

[Install]
WantedBy=multi-user.target
```

### Enable Services

```bash
systemctl daemon-reload
systemctl enable --now pistonprotection-gateway
systemctl enable --now pistonprotection-worker
```

## Verify Installation

```bash
# Check service status
systemctl status pistonprotection-gateway
systemctl status pistonprotection-worker

# Check health endpoint
curl http://localhost:8080/health

# Check eBPF programs loaded
bpftool prog list

# View logs
journalctl -u pistonprotection-gateway -f
journalctl -u pistonprotection-worker -f
```

## Monitoring

Install node_exporter for system metrics:

```bash
# Install node_exporter
wget https://github.com/prometheus/node_exporter/releases/download/v1.8.0/node_exporter-1.8.0.linux-amd64.tar.gz
tar xvfz node_exporter-*.tar.gz
cp node_exporter-*/node_exporter /usr/local/bin/

# Create service
cat > /etc/systemd/system/node_exporter.service <<EOF
[Unit]
Description=Node Exporter
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/node_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable --now node_exporter
```
